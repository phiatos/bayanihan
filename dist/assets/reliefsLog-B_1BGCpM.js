import"./global-Dd8t204S.js";/* empty css                */document.addEventListener("DOMContentLoaded",()=>{const $={apiKey:"AIzaSyDJxMv8GCaMvQT2QBW3CdzA3dV5X_T2KqQ",authDomain:"bayanihan-5ce7e.firebaseapp.com",databaseURL:"https://bayanihan-5ce7e-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"bayanihan-5ce7e",storageBucket:"bayanihan-5ce7e.appspot.com",messagingSenderId:"593123849917",appId:"1:593123849917:web:eb85a63a536eeff78ce9d4",measurementId:"G-ZTQ9VXXVV0"};try{firebase.initializeApp($),console.log("Firebase initialized successfully")}catch(t){console.error("Firebase initialization failed:",t)}const y=firebase.database(),v=document.querySelector("#orgTable tbody"),P=document.getElementById("searchInput"),R=document.getElementById("sortSelect"),N=document.getElementById("entriesInfo"),w=document.getElementById("pagination"),B=document.getElementById("savePdfBtn"),E=document.getElementById("exportExcelBtn");if(!v||!P||!R||!N||!w||!B||!E){console.error("One or more DOM elements are missing:",{tableBody:!!v,searchInput:!!P,sortSelect:!!R,entriesInfo:!!N,pagination:!!w,savePdfBtn:!!B,exportExcelBtn:!!E});return}let u=[],f=[],p=1;const I=5;B.addEventListener("click",()=>{if(f.length===0){Swal.fire("Info","No data to export to PDF!","info");return}Swal.fire({title:"Generating PDF...",text:"Please wait while the PDF is being created.",allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});const{jsPDF:t}=window.jspdf,n=new t("landscape");let e=20;const o=new Image;o.src="../assets/images/AB_logo.png",o.onload=function(){const a=n.internal.pageSize.width,r=30,i=o.naturalHeight/o.naturalWidth*r,g=14;n.addImage(o,"PNG",a-r-g,g,r,i),n.setFontSize(18),n.text("Relief Request Log Report",14,e),e+=10,n.setFontSize(10),n.text(`Report Generated: ${new Date().toLocaleString()}`,14,e),e+=15;const l=["No.","Relief ID","Volunteer Group Name","City","Drop-off Address","Contact Person","Contact Number","Request Category","Items (Name & Qty)","Status","Notes"],s=f.map((d,x)=>{const S=(d.items||[]).map(m=>`${m.name} (Qty: ${m.quantity})`).join(`
`);return[x+1,d.id||"N/A",d.group||"N/A",d.city||"N/A",d.address||"N/A",d.contact||"N/A",d.number||"N/A",d.category||"N/A",S||"N/A",d.status||"Pending",d.notes||"N/A"]});n.autoTable({head:[l],body:s,startY:e,theme:"grid",headStyles:{fillColor:[20,174,187],textColor:[255,255,255],halign:"center",fontSize:8},styles:{fontSize:8,cellPadding:2,overflow:"linebreak"},columnStyles:{0:{cellWidth:10},1:{cellWidth:20},2:{cellWidth:30},3:{cellWidth:25},4:{cellWidth:40},5:{cellWidth:25},6:{cellWidth:20},7:{cellWidth:25},8:{cellWidth:35},9:{cellWidth:15},10:{cellWidth:25}},didDrawPage:function(d){n.setFontSize(8);const x=`Page ${d.pageNumber} of ${n.internal.getNumberOfPages()}`,S="Powered by: Appvance",m=n.internal.pageSize.width,h=d.settings.margin.left,C=n.internal.pageSize.height-10;n.text(x,h,C),n.text(S,m-h,C,{align:"right"})}});const c=`Relief_Request_Log_${new Date().toISOString().slice(0,10)}.pdf`;n.save(c),Swal.close(),Swal.fire("Success",`Relief Request Log exported to "${c}"`,"success")},o.onerror=function(){Swal.fire("Error","Failed to load logo image. Please check the path.","error")}}),y.ref("requestRelief/requests").on("value",t=>{console.log("Fetching data from Firebase"),u=[];const n=t.val();n?(Object.keys(n).forEach((e,o)=>{const a=n[e],r=a.volunteerOrganization||"[Unknown Org]";a.volunteerOrganization||console.warn(`Relief request ${e} is missing volunteerOrganization field. Using default: [Unknown Org]`),u.push({id:`RR${String(o+1).padStart(3,"0")}`,group:r,city:a.city,address:a.address,contact:a.contactPerson,number:a.contactNumber,email:a.email,category:a.category,userUid:a.userUid||"N/A",items:a.items||[],firebaseKey:e,status:a.status||"",notes:a.notes||""})}),console.log("Data fetched successfully:",u)):console.log("No data found in requestRelief/requests"),f=[...u],b()},t=>{console.error("Error fetching data from Firebase:",t),Swal.fire({icon:"error",title:"Error",text:"Failed to load relief requests: "+t.message})});function b(){console.log("Rendering table"),v.innerHTML="";const t=(p-1)*I,n=t+I;f.slice(t,n).forEach((o,a)=>{const r=document.createElement("tr"),i=t+a;r.innerHTML=`
                <td data-key="No">${i+1}</td>
                <td data-key="ReliefID">${o.id}</td>
                <td data-key="VolunteerGroupName">${o.group}</td>
                <td data-key="City">${o.city}</td>
                <td data-key="DropoffAddress">${o.address}</td>
                <td data-key="ContactPerson">${o.contact}</td>
                <td data-key="ContactNumber">${o.number}</td>
                <td data-key="RequestCategory">${o.category}</td>

                <!-- Status dropdown -->
                <td>
                    <select class="statusSelect" data-id="${o.id}">
                        <option disabled selected value="">Select Status</option>
                        <option value="Pending" ${o.status==="Pending"?"selected":""}>Pending</option>
                        <option value="Completed" ${o.status==="Completed"?"selected":""}>Completed</option>
                    </select>
                </td>

                <!-- Notes column -->
                <td>
                    <textarea class="notesInput" maxlength="50" rows="3" data-id="${o.id}">${o.notes||""}</textarea>
                </td>

                <td>
                    <button class="saveBtn" data-key="${o.firebaseKey}">Save </button>
                    <button class="viewBtn" data-index="${u.indexOf(o)}">View</button>
                    <button class="deleteBtn" data-key="${o.firebaseKey}">Remove</button>
                    <button class="savePDFBtn" data-index="${u.indexOf(o)}">Save PDF</button>
                </td>
            `,v.appendChild(r)}),N.textContent=`Showing ${f.length?t+1:0} to ${Math.min(n,f.length)} of ${f.length} entries`,L(),D()}function D(){document.querySelectorAll(".saveBtn").forEach(t=>{t.addEventListener("click",function(){const n=this.dataset.key,e=this.closest("tr"),o=e.querySelector(".statusSelect").value,a=e.querySelector(".notesInput").value;y.ref(`requestRelief/requests/${n}`).update({status:o,notes:a}).then(()=>{Swal.fire({icon:"success",title:"Saved!",text:"Status and notes updated successfully.",timer:1500,showConfirmButton:!1,timerProgressBar:!0,customClass:{popup:"swal2-popup-success-clean",title:"swal2-title-success-clean",content:"swal2-text-success-clean"}})}).catch(r=>{console.error("Error saving to Firebase:",r),Swal.fire({icon:"error",title:"Save failed",text:r.message,timer:2500,showConfirmButton:!1,timerProgressBar:!0,customClass:{popup:"swal2-popup-error-clean",title:"swal2-title-error-clean",content:"swal2-text-error-clean"}})})})})}document.getElementById("closeModal").addEventListener("click",()=>{document.getElementById("reliefModal").classList.add("hidden")});function L(){w.innerHTML="";const t=Math.ceil(f.length/I);if(t===0){w.innerHTML="<span>No entries to display</span>";return}const n=(r,i,g=!1,l=!1)=>{const s=document.createElement("button");return s.textContent=r,g&&(s.disabled=!0),l&&s.classList.add("active-page"),s.addEventListener("click",()=>{p=i,b()}),s};w.appendChild(n("Prev",p-1,p===1));const e=5;let o=Math.max(1,p-Math.floor(e/2)),a=Math.min(t,o+e-1);a-o<e-1&&(o=Math.max(1,a-e+1));for(let r=o;r<=a;r++)w.appendChild(n(r,r,!1,r===p));w.appendChild(n("Next",p+1,p===t))}document.getElementById("sortSelect").addEventListener("change",function(){const t=this.value;if(!t)return;const[n,e]=t.split("-");F(n,e)});function F(t,n="asc"){f.sort((e,o)=>{const a={No:(s,c)=>c+1,ReliefID:s=>s.id,VolunteerGroupName:s=>s.group,City:s=>s.city,DropoffAddress:s=>s.address,ContactPerson:s=>s.contact,ContactNumber:s=>s.number,RequestCategory:s=>s.category},r=typeof a[t]=="function"?a[t](e,u.indexOf(e)):"",i=typeof a[t]=="function"?a[t](o,u.indexOf(o)):"",g=isNaN(r)?String(r).toLowerCase():parseFloat(r),l=isNaN(i)?String(i).toLowerCase():parseFloat(i);return g<l?n==="asc"?-1:1:g>l?n==="asc"?1:-1:0}),p=1,b()}document.addEventListener("click",t=>{if(t.target.classList.contains("viewBtn")){console.log("View button clicked");const n=parseInt(t.target.dataset.index),e=u[n];document.getElementById("modalTitle").textContent=`Relief Request of ${e.group}`,document.getElementById("modalContact").textContent=e.contact,document.getElementById("modalNumber").textContent=e.number,document.getElementById("modalEmail").textContent=e.email||"N/A",document.getElementById("modalAddress").textContent=e.address,document.getElementById("modalCategory").textContent=e.category,document.getElementById("modalGroup").textContent=e.group;const o=document.querySelector("#itemsTable tbody");o.innerHTML="",(e.items||[]).forEach(a=>{o.insertAdjacentHTML("beforeend",`<tr><td>${a.name}</td><td>${a.quantity}</td><td>${a.notes}</td></tr>`)}),document.getElementById("reliefModal").classList.remove("hidden")}if(t.target.classList.contains("savePDFBtn")){const n=parseInt(t.target.dataset.index),e=u[n];e?T(e):Swal.fire("Error","Could not find the relief request data to export.","error")}if(t.target.classList.contains("deleteBtn")){const n=t.target.dataset.key;console.log("Delete button clicked for ID:",n),Swal.fire({title:"Are you sure?",text:"You will not be able to recover this request!",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, delete it!",cancelButtonText:"No, cancel!"}).then(e=>{e.isConfirmed&&y.ref(`requestRelief/requests/${n}`).once("value",o=>{const r=o.val().userUid;Promise.all([y.ref(`requestRelief/requests/${n}`).remove(),y.ref(`users/${r}/requests/${n}`).remove()]).then(()=>{Swal.fire("Deleted!","The request has been deleted.","success"),u=u.filter(i=>i.firebaseKey!==n),f=[...u],b()}).catch(i=>{Swal.fire("Error!","Failed to delete the request. Please try again.","error"),console.error("Delete failed:",i)})})})}}),P.addEventListener("input",function(){const t=this.value.toLowerCase();f=u.filter(n=>Object.values(n).some(e=>String(e).toLowerCase().includes(t))),p=1,b()}),E.addEventListener("click",()=>{Swal.fire({title:"Generating Excel...",text:"Please wait while the Excel file is being created.",allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});try{const t=[],n=["No.","Relief ID","Volunteer Group Name","City","Drop-off Address","Contact Person","Contact Number","Request Category","Items (Name & Qty)","Status","Notes"];t.push(n),f.forEach((r,i)=>{const g=(r.items||[]).map(l=>`${l.name} (Qty: ${l.quantity})`).join(", ");t.push([i+1,r.id,r.group,r.city,r.address,r.contact,r.number,r.category,g,r.status||"Pending",r.notes||"N/A"])});const e=XLSX.utils.aoa_to_sheet(t),o=[{wch:5},{wch:15},{wch:30},{wch:20},{wch:40},{wch:25},{wch:20},{wch:25},{wch:35},{wch:15},{wch:35}];e["!cols"]=o;const a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,e,"Relief Requests"),XLSX.writeFile(a,"Relief_Request_Log.xlsx"),Swal.close(),Swal.fire({title:"Success!",text:"Excel file generated successfully!",icon:"success",timer:1500,showConfirmButton:!1})}catch(t){console.error("Error generating Excel:",t),Swal.close(),Swal.fire("Error!","Failed to generate Excel: "+t.message,"error")}});function T(t){Swal.fire({title:"Generating PDF...",text:"Please wait while the PDF file is being created.",allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});const{jsPDF:n}=window.jspdf,e=new n("portrait"),o=new Image;o.src="../assets/images/AB_logo.png",o.onload=function(){const a=e.internal.pageSize.width,r=e.internal.pageSize.height,i=30,g=o.naturalHeight/o.naturalWidth*i,l=14;let s=l;e.addImage(o,"PNG",a-i-l,l,i,g),e.setFontSize(18),e.text("Relief Request Details",l,s+8),s+=18,e.setFontSize(10),e.text(`Report Generated: ${new Date().toLocaleString()}`,l,s),s+=15;const c=(m,h,C=!1)=>{if(s>r-l-20&&(e.addPage(),s=l,e.addImage(o,"PNG",a-i-l,l,i,g),e.setFontSize(14),e.text("Relief Request Details (Cont.)",l,s+8),s+=18),e.setFontSize(C?12:10),C)e.setTextColor(20,174,187),e.text(`${m}`,l,s),e.setTextColor(0),s+=7;else{const k=`â€¢ ${m}: ${h||"-"}`,q=e.splitTextToSize(k,a-2*l);e.text(q,l,s),s+=q.length*5}};if(e.setFontSize(14),e.setTextColor(20,174,187),e.text(`Relief ID: ${t.id||"-"}`,l,s),s+=10,e.setTextColor(0),c("Basic Information","",!0),c("Volunteer Group Name",t.group||"[Unknown Org]"),c("Request Category",t.category||"-"),c("Contact Person",t.contact||"-"),c("Contact Number",t.number||"-"),c("Email",t.email||"-"),c("City",t.city||"-"),c("Drop-off Address",t.address||"-"),c("Current Status",t.status||"Pending"),c("Notes",t.notes||"N/A"),s+=5,t.items&&t.items.length>0){c("Requested Items","",!0);const m=t.items.map(h=>[h.name||"-",h.quantity||"-",h.notes||"N/A"]);e.autoTable({startY:s,head:[["Item Name","Quantity","Notes"]],body:m,theme:"grid",headStyles:{fillColor:[20,174,187],textColor:[255,255,255],halign:"center",fontSize:8},styles:{fontSize:8,cellPadding:2,overflow:"linebreak"},margin:{left:l,right:l}}),s=e.autoTable.previous.finalY+10}else c("Requested Items","No items specified."),s+=5;e.setFontSize(8);const d=r-10,x=`Page ${e.internal.getNumberOfPages()}`,S="Powered by: Appvance";e.text(x,l,d),e.text(S,a-l,d,{align:"right"}),e.save(`Relief_Request_${t.id||"Details"}.pdf`),Swal.close(),Swal.fire({icon:"success",title:"PDF Generated!",text:`Relief Request "${t.id||"Details"}" saved as PDF.`,timer:2e3,showConfirmButton:!1,color:"#1b5e20",iconColor:"#43a047",confirmButtonColor:"#388e3c",confirmButtonText:"Great!",customClass:{popup:"swal2-popup-success-export",title:"swal2-title-success-export",content:"swal2-text-success-export",confirmButton:"swal2-button-success-export"}})},o.onerror=function(){Swal.close(),Swal.fire("Error","Failed to load logo image. Please check the path.","error")}}});
